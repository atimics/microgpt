name: CI

on:
  push:
    branches: ['*']
  pull_request:
    branches: ['*']

permissions:
  contents: write
  pull-requests: write

jobs:
  test:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.11', '3.12']
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install build deps
        run: pip install setuptools

      - name: Build C extension
        run: python setup.py build_ext --inplace

      - name: Run smoke tests
        run: python test_smoke.py --quick

  benchmark:
    runs-on: ubuntu-latest
    needs: test

    steps:
      - uses: actions/checkout@v4
        with:
          # Fetch full history so we can push baseline updates
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install build deps
        run: pip install setuptools

      - name: Build C extension
        run: python setup.py build_ext --inplace

      - name: Run full smoke tests
        run: python test_smoke.py

      - name: Run benchmark
        run: python benchmark.py run --output current.json

      # --- Generate charts and reports ---
      - name: Generate charts
        id: charts
        if: hashFiles('baseline.json') != ''
        run: |
          mkdir -p charts
          python report_charts.py full baseline.json current.json --output-dir charts
          echo "has_charts=true" >> "$GITHUB_OUTPUT"

      - name: Generate comparison text
        id: compare
        if: hashFiles('baseline.json') != ''
        run: |
          python benchmark.py compare baseline.json current.json --md --output report.md
          python benchmark.py compare baseline.json current.json --output report.txt
          echo "has_baseline=true" >> "$GITHUB_OUTPUT"

      # --- Step summary with charts ---
      - name: Post report to step summary
        if: steps.charts.outputs.has_charts == 'true'
        run: |
          # Use the chart-enhanced report
          cat charts/report.md >> "$GITHUB_STEP_SUMMARY"

      - name: Post text comparison to step summary
        if: steps.compare.outputs.has_baseline == 'true' && steps.charts.outputs.has_charts != 'true'
        run: |
          echo "## Benchmark Comparison" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          tail -n +2 report.md >> "$GITHUB_STEP_SUMMARY"

      # --- PR comment with charts ---
      - name: Comment on PR
        if: github.event_name == 'pull_request' && steps.charts.outputs.has_charts == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUM=${{ github.event.pull_request.number }}
          COMMENT_TAG="<!-- microgpt-benchmark -->"
          BODY=$(cat charts/report.md)

          # Find existing benchmark comment and update it, or create new
          EXISTING=$(gh api "repos/${{ github.repository }}/issues/${PR_NUM}/comments" \
            --jq ".[] | select(.body | startswith(\"${COMMENT_TAG}\")) | .id" \
            | head -1)

          if [ -n "$EXISTING" ]; then
            gh api "repos/${{ github.repository }}/issues/comments/${EXISTING}" \
              -X PATCH -f body="$BODY"
            echo "Updated existing comment $EXISTING"
          else
            gh pr comment "$PR_NUM" --body "$BODY"
            echo "Created new comment"
          fi

      - name: Comment on PR (text fallback)
        if: github.event_name == 'pull_request' && steps.compare.outputs.has_baseline == 'true' && steps.charts.outputs.has_charts != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUM=${{ github.event.pull_request.number }}
          COMMENT_TAG="<!-- microgpt-benchmark -->"
          BODY=$(cat report.md)

          EXISTING=$(gh api "repos/${{ github.repository }}/issues/${PR_NUM}/comments" \
            --jq ".[] | select(.body | startswith(\"${COMMENT_TAG}\")) | .id" \
            | head -1)

          if [ -n "$EXISTING" ]; then
            gh api "repos/${{ github.repository }}/issues/comments/${EXISTING}" \
              -X PATCH -f body="$BODY"
          else
            gh pr comment "$PR_NUM" --body "$BODY"
          fi

      # --- Update baseline on main branch pushes ---
      - name: Update baseline
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          # Skip if this push was a baseline update (avoid infinite loop)
          LAST_MSG=$(git log -1 --pretty=%s)
          if echo "$LAST_MSG" | grep -q "Update baseline.json"; then
            echo "Skipping: last commit was a baseline update"
            exit 0
          fi

          cp current.json baseline.json
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add baseline.json
          if git diff --cached --quiet; then
            echo "No changes to baseline"
          else
            git commit -m "Update baseline.json [skip ci]"
            git push
            echo "Baseline updated"
          fi

      # --- Generate detailed roofline reports ---
      - name: Generate roofline report
        run: |
          python roofline.py --all-configs --json roofline_report.json 2>&1 | tee roofline_output.txt

      - name: Generate reference vs fast comparison
        run: |
          python roofline.py --all-configs --compare-ref --json roofline_compare.json 2>&1 | tee roofline_compare.txt

      - name: Post roofline summary
        if: always()
        run: |
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "## Roofline Analysis" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          python -c "
          import json
          with open('roofline_report.json') as f:
              data = json.load(f)
          cpu = data['cpu']
          bw = data['bandwidth']
          print(f\"CPU: {cpu['model']}\")
          print(f\"Peak: {cpu['peak_gflops']:.1f} GFLOPS | DRAM BW: {bw['raw_gbs']:.1f} GB/s\")
          print()
          print(f\"{'Config':<20} {'Params':>8} {'ms/step':>10} {'GFLOPS':>10} {'Eff%':>8} {'Bound':>8}\")
          print('-' * 66)
          for r in data['results']:
              c = r['config']
              label = f\"e{c['n_embd']}_L{c['n_layer']}_b{c['block_size']}\"
              ms = f\"{r['step_time_ms']:.1f}\" if 'step_time_ms' in r else '-'
              gf = f\"{r['achieved_gflops']:.4f}\" if 'achieved_gflops' in r else '-'
              eff = f\"{r['efficiency_pct']:.3f}\" if 'efficiency_pct' in r else '-'
              bnd = r.get('bottleneck', '-')
              print(f\"{label:<20} {r['num_params']:>8,} {ms:>10} {gf:>10} {eff:>7}% {bnd:>8}\")
          " >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"

      # --- Upload all artifacts ---
      - name: Upload reports and charts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: performance-reports
          path: |
            baseline.json
            current.json
            report.md
            report.txt
            roofline_report.json
            roofline_output.txt
            roofline_compare.json
            roofline_compare.txt
            charts/
          retention-days: 30
